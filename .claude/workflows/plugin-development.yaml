# Plugin Development Workflow
# Operator-based TDD with subagent delegation
#
# Design principles:
# - Claude acts as OPERATOR, delegating to subagents for actual work
# - Fewer phases, more intelligence per phase
# - RED/GREEN/REFACTOR handled within single development iteration

name: Plugin Development Workflow
description: |
  Streamlined TDD workflow where Claude operates as an intelligent coordinator.

  Each development step spawns subagents for:
  - RED: Write failing tests
  - GREEN: Implement to pass tests
  - REFACTOR: Clean up code

  The operator monitors progress, handles failures, and ensures quality.

phases:
  # ============================================================================
  # Phase 1: PREFLIGHT
  # Sprint planning and context gathering
  # ============================================================================
  - id: preflight
    prompt: |
      Prepare sprint context and development plan.

      ## Your Role
      You are the sprint OPERATOR. Your job is to:
      1. Understand the sprint scope
      2. Research the codebase
      3. Create shared context for development phases

      ## Step 1: Read Sprint Definition
      Read the SPRINT.yaml to understand:
      - All steps and their requirements
      - Dependencies between steps
      - Overall sprint goal

      ## Step 2: Research Codebase
      Use the Explore subagent to investigate:
      - Project architecture and patterns
      - Test framework and conventions
      - Build/test/lint commands
      - Related existing code

      ## Step 3: Create Shared Context
      Create: context/_shared-context.md

      ```markdown
      # Sprint Context

      ## Project Info
      - Test framework: [vitest/jest/etc]
      - Test location: [pattern]
      - Build command: `[command]`
      - Test command: `[command]`
      - Lint command: `[command]`

      ## Patterns to Follow
      [Key patterns discovered in codebase]

      ## Sprint Steps Overview
      [Brief summary of each step and dependencies]
      ```

      ## Step 4: Commit
      ```bash
      git add context/
      git commit -m "preflight: sprint context prepared"
      ```

  # ============================================================================
  # Phase 2: DEVELOPMENT
  # Operator-driven TDD for each step
  # ============================================================================
  - id: development
    for-each: step
    prompt: |
      ## Your Role: TDD OPERATOR

      You coordinate the TDD cycle by spawning subagents for each phase.

      ## Step Requirements
      {{step.prompt}}

      ## Context
      Read: context/_shared-context.md

      ---

      ## TDD CYCLE: Execute in Order

      ### 1. RED Phase (Write Failing Tests)

      Spawn a subagent to write tests FIRST:

      ```
      Task: RED - Write failing tests for {{step.id}}

      Requirements:
      {{step.prompt}}

      Instructions:
      1. Read context/_shared-context.md for test patterns
      2. Create test file(s) following project conventions
      3. Write 4-8 test cases covering happy path, edge cases, errors
      4. Tests should FAIL (no implementation yet)
      5. Commit: git commit -m "test({{step.id}}): add failing tests [RED]"
      ```

      **Verify RED**: Run tests, confirm they fail (expected).

      ### 2. GREEN Phase (Implement to Pass)

      Spawn a subagent to implement:

      ```
      Task: GREEN - Implement {{step.id}} to pass tests

      Requirements:
      {{step.prompt}}

      Instructions:
      1. Read the test files to understand expected behavior
      2. Implement MINIMAL code to pass all tests
      3. Run tests frequently
      4. Don't optimize - just make tests pass
      5. Commit: git commit -m "feat({{step.id}}): implementation [GREEN]"
      ```

      **Verify GREEN**: Run tests, confirm they ALL pass.

      ### 3. REFACTOR Phase (Clean Up)

      Spawn a subagent to refactor:

      ```
      Task: REFACTOR - Clean up {{step.id}} implementation

      Instructions:
      1. Remove duplication, improve naming
      2. Run tests after EACH change - revert if tests fail
      3. Run lint and fix issues
      4. Commit: git commit -m "refactor({{step.id}}): code cleanup"
      ```

      **Verify REFACTOR**: Run tests + lint + typecheck, all must pass.

      ---

      ## OPERATOR DECISIONS

      - If tests fail unexpectedly: retry with more context or spawn fix subagent
      - If implementation incomplete: spawn another GREEN subagent
      - If blocked: escalate to human

      ## Final Output

      Create: artifacts/{{step.id}}-complete.md

      ```markdown
      # Step Complete: {{step.id}}

      ## TDD Cycle
      - RED: [N] tests written
      - GREEN: Implementation complete
      - REFACTOR: Code cleaned

      ## Files Changed
      [List]

      ## Status: COMPLETE
      ```

      Commit:
      ```bash
      git add artifacts/{{step.id}}-complete.md
      git commit -m "complete({{step.id}}): TDD cycle finished"
      ```

  # ============================================================================
  # Phase 3: DOCUMENTATION
  # Operator spawns subagents for each doc category
  # ============================================================================
  - id: documentation
    prompt: |
      ## Your Role: Documentation OPERATOR

      Update documentation by spawning subagents for each category.

      ## Step 1: Analyze Changes
      ```bash
      git diff main..HEAD --name-only
      git diff main..HEAD --stat
      ```

      Create a list of what changed and needs documenting.

      ## Step 2: Spawn Subagents (in parallel if independent)

      ### User Guide Subagent
      ```
      Task: Update user guide documentation

      Changes made in this sprint:
      [List relevant changes]

      Instructions:
      1. Find existing user guide (docs/USER-GUIDE.md or docs/user-guide/)
      2. Add/update sections for new features
      3. Update examples if behavior changed
      4. Keep it task-oriented and example-rich
      5. Commit: git commit -m "docs(user-guide): update for sprint changes"

      Skip if: No user-facing feature changes
      ```

      ### Getting Started Subagent
      ```
      Task: Update getting started / quickstart docs

      Changes made in this sprint:
      [List relevant changes]

      Instructions:
      1. Find quickstart docs (README.md, docs/getting-started/)
      2. Update installation steps if changed
      3. Update first-steps examples if affected
      4. Ensure copy-paste commands work
      5. Commit: git commit -m "docs(getting-started): update for sprint changes"

      Skip if: No changes affect onboarding flow
      ```

      ### Reference Docs Subagent
      ```
      Task: Update reference documentation

      Changes made in this sprint:
      [List relevant changes]

      Instructions:
      1. Find reference docs (docs/reference/, API docs)
      2. Update command/function signatures
      3. Update configuration options
      4. Update type definitions
      5. Commit: git commit -m "docs(reference): update for sprint changes"

      Skip if: No API/config/type changes
      ```

      ## Step 3: Verify All Documentation
      - Run code examples from docs to verify they work
      - Check internal links are valid
      - Ensure consistency across all doc updates

      ## Output
      Create: artifacts/docs-summary.md

      ```markdown
      # Documentation Summary

      ## Changes Analyzed
      [What changed in the sprint]

      ## Updates Made
      | Category | Status | Changes |
      |----------|--------|---------|
      | User Guide | Updated/Skipped | [summary] |
      | Getting Started | Updated/Skipped | [summary] |
      | Reference | Updated/Skipped | [summary] |

      ## Verification
      - [ ] Code examples tested
      - [ ] Links validated
      ```

  # ============================================================================
  # Phase 4: FINAL-QA
  # Comprehensive quality verification
  # ============================================================================
  - id: final-qa
    prompt: |
      ## Your Role: QA OPERATOR

      Verify the entire sprint meets quality standards.

      ## Step 1: Build Verification
      ```bash
      npm run build
      npm run typecheck
      npm run lint
      ```

      All must pass. If any fail, spawn fix subagent.

      ## Step 2: Full Test Suite
      ```bash
      npm test
      ```

      All tests must pass. Record coverage if available.

      ## Step 3: Review All Step Artifacts
      Read each artifacts/{{step.id}}-complete.md to verify all steps finished.

      ## Step 4: Integration Check
      - Verify modules import correctly
      - Check for circular dependencies
      - Run any integration tests

      ## Step 5: Generate QA Report
      Create: artifacts/sprint-qa-report.md

      ```markdown
      # Sprint QA Report

      ## Build Status
      | Check | Status |
      |-------|--------|
      | Build | PASS/FAIL |
      | TypeCheck | PASS/FAIL |
      | Lint | PASS/FAIL |

      ## Test Results
      - Total: [N]
      - Passed: [N]
      - Failed: [N]
      - Coverage: [%]

      ## Step Verification
      | Step | Status |
      |------|--------|
      | [step-id] | COMPLETE |

      ## Overall: PASS / FAIL
      ```

      ## Handle Failures
      If any check fails:
      1. Spawn fix subagent with specific error details
      2. Re-run verification
      3. If still failing, escalate to human

      Commit:
      ```bash
      git add artifacts/sprint-qa-report.md
      git commit -m "qa: sprint verification complete"
      ```

  # ============================================================================
  # Phase 5: SUMMARY
  # Generate sprint deliverables
  # ============================================================================
  - id: summary
    prompt: |
      Generate sprint summary for PR.

      ## Collect Information
      - Read all artifacts/*-complete.md
      - Read artifacts/sprint-qa-report.md
      - Get commit history: `git log main..HEAD --oneline`
      - Get file changes: `git diff main..HEAD --stat`

      ## Create Summary
      Create: artifacts/sprint-summary.md

      ```markdown
      # Sprint Summary: {{sprint.id}}

      ## Completed Steps
      [For each step: what was accomplished]

      ## Test Coverage
      - Tests added: [N]
      - All tests passing: Yes

      ## Files Changed
      [Summary of changes]

      ## Commits
      [List of commits]

      ## Ready for Review
      - Build: PASS
      - Tests: PASS
      - Lint: PASS
      - Docs: Updated
      ```

      Commit:
      ```bash
      git add artifacts/sprint-summary.md
      git commit -m "docs: sprint summary"
      ```

  # ============================================================================
  # Phase 6: PR-CREATE
  # Push and create pull request
  # ============================================================================
  - id: pr-create
    prompt: |
      Push branch and create pull request.

      ## Step 1: Verify Clean State
      ```bash
      git status
      ```

      ## Step 2: Push Branch
      ```bash
      git push -u origin HEAD
      ```

      ## Step 3: Create PR
      Read artifacts/sprint-summary.md for PR body content.

      ```bash
      gh pr create \
        --title "{{sprint.id}}" \
        --body "$(cat <<'EOF'
      ## Summary
      [Key points from sprint-summary.md]

      ## Changes
      [List major changes]

      ## Verification
      - [x] Build passes
      - [x] All tests pass
      - [x] Lint passes
      - [x] Documentation updated

      ---
      See `artifacts/sprint-summary.md` for full details.
      EOF
      )"
      ```

      ## Step 4: Output PR URL
      ```bash
      gh pr view --json url -q '.url'
      ```
