# SPRINT.yaml - Workflow-based Sprint Definition
# This file is compiled into PROGRESS.yaml by /run-sprint

workflow: flat-foreach-qa    # Custom workflow with QA steps for each implementation

steps:
  - prompt: |
      Create TypeScript interfaces for status events and server config.

      File: compiler/src/status-server/status-types.ts

      Requirements:
      - StatusUpdate interface with sprint state, phase tree, current task
      - LogEntry interface for activity feed entries
      - ServerConfig interface with port, host, sprint directory
      - SSE event types (status-update, log-entry, keep-alive)

  - prompt: |
      Create file watcher with debounce for PROGRESS.yaml changes.

      File: compiler/src/status-server/watcher.ts

      Requirements:
      - Watch PROGRESS.yaml file using fs.watch()
      - Implement 100ms debounce to prevent excessive updates
      - Emit events on file changes
      - Handle file deletion/recreation gracefully

  - prompt: |
      Create data transformation functions.

      File: compiler/src/status-server/transforms.ts

      Requirements:
      - Convert CompiledProgress to StatusUpdate format
      - Generate log entries for status changes (started, completed, failed)
      - Calculate progress percentages
      - Format timestamps for display

  - prompt: |
      Create HTML page with embedded CSS and JavaScript.

      File: compiler/src/status-server/page.ts

      Requirements:
      - Dark theme, monospace font
      - Header: sprint name, status badge, progress bar, iteration count
      - Left panel: hierarchical phase tree with status icons
      - Right top: current task (path, prompt, started time)
      - Right bottom: activity feed (log entries)
      - Client JS uses EventSource for SSE connection
      - All CSS/JS embedded as template literal (no external files)

  - prompt: |
      Create HTTP server with SSE endpoint.

      File: compiler/src/status-server/server.ts

      Requirements:
      - Use Node.js built-in http module
      - GET / - serve HTML page
      - GET /events - SSE endpoint with keep-alive
      - GET /api/status - JSON API (optional)
      - Integrate watcher and transforms
      - Handle client disconnections gracefully

  - prompt: |
      Create CLI entry point.

      File: compiler/src/status-server/index.ts

      Requirements:
      - Use commander for CLI parsing
      - Command: sprint-status-server <sprint-dir> [--port N] [--host HOST]
      - Default port: 3100
      - Default host: localhost
      - Write port to .sprint-status.port file for discovery
      - Show server URL on startup

  - prompt: |
      Update package.json with new bin entry.

      File: compiler/package.json

      Requirements:
      - Add "sprint-status-server": "./dist/status-server/index.js" to bin section
      - Ensure it's alongside existing "sprint-compile" entry

  - prompt: |
      Add iteration fields to SprintStats interface.

      File: compiler/src/types.ts

      Requirements:
      - Add 'current-iteration'?: number field
      - Add 'max-iterations'?: number field
      - Update SprintStats interface in existing types

  - prompt: |
      Update sprint loop to write iteration to PROGRESS.yaml.

      File: scripts/sprint-loop.sh (around line 249)

      Requirements:
      - Write current iteration using yq: .stats."current-iteration" = $i
      - Write max iterations using yq: .stats."max-iterations" = $MAX_ITERATIONS
      - Place updates after PROGRESS.yaml is created/updated

  - prompt: |
      Update run-sprint command to start status server.

      File: commands/run-sprint.md

      Requirements:
      - Launch sprint-status-server after starting sprint loop
      - Read port from .sprint-status.port file
      - Display "Live Status: http://localhost:{port}" message
      - Handle case where status server fails to start

  - prompt: |
      Create new command for standalone status server.

      File: commands/sprint-watch.md

      Requirements:
      - Document sprint-watch command
      - Usage: /sprint-watch [sprint-dir]
      - Start status server for existing sprint
      - Show URL and usage instructions

  - prompt: |
      Build and verify the implementation.

      Requirements:
      - Run: cd plugins/m42-sprint/compiler && npm run build
      - Verify: node dist/status-server/index.js --help
      - Test manual workflow: create test sprint, start server, edit PROGRESS.yaml
      - Test integration: run actual sprint and verify live updates
      - Fix any build errors or runtime issues

# Sprint metadata
sprint-id: 2026-01-16_visual-status-page
name: visual-status-page
created: 2026-01-16T11:16:43+01:00
description: Create a live, non-interactive web status page that displays sprint progress in real-time
