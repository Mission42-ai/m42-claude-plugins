# SPRINT.yaml - Parallel Execution Feature for m42-sprint Plugin
# This file is compiled into PROGRESS.yaml by /run-sprint

workflow: gherkin-verified-execution

steps:
  # Step 1: Type System Extensions
  - prompt: |
      Add parallel execution types to compiler/src/types.ts:

      1. Add `parallel?: boolean` to WorkflowPhase interface (lines 68-77)
      2. Add `wait-for-parallel?: boolean` to WorkflowPhase interface
      3. Create new ParallelTask interface with fields:
         - id, step-id, phase-id
         - status: 'spawned' | 'running' | 'completed' | 'failed'
         - pid, log-file, spawned-at, completed-at, exit-code, error
      4. Add `parallel-tasks?: ParallelTask[]` to CompiledProgress (lines 202-211)
      5. Add `parallel?: boolean` and `parallel-task-id?: string` to CompiledPhase (lines 101-119)
      6. Add `wait-for-parallel?: boolean` to CompiledTopPhase (lines 148-168)

      Reference: context/implementation-plan.md sections 4.A and 5

  # Step 2: Update Compiler - Expand ForEach
  - prompt: |
      Update compiler/src/expand-foreach.ts to propagate parallel flag:

      1. In expandStep() function (lines 84-130)
      2. When creating CompiledPhase objects in the map (line 117-121)
      3. Add: `parallel: phase.parallel` to propagate the flag from WorkflowPhase to CompiledPhase

      This ensures sub-phases marked as parallel in workflow definitions are compiled with the parallel flag.

      Reference: context/implementation-plan.md section 4.B

  # Step 3: Update Compiler - Main Compile
  - prompt: |
      Update compiler/src/compile.ts to initialize parallel-tasks array:

      1. In the compile() function around line 209 where CompiledProgress is built
      2. Add initialization: `'parallel-tasks': []`
      3. Propagate `wait-for-parallel` from WorkflowPhase to CompiledTopPhase in expandForEach and compileSimplePhase

      Reference: context/implementation-plan.md section 4.C

  # Step 4: Add Validation Rules
  - prompt: |
      Update compiler/src/validate.ts with parallel validation:

      1. In validateWorkflowPhase() function (lines 174-235)
      2. Add validation for `parallel` property (must be boolean if present)
      3. Add validation for `wait-for-parallel` property (must be boolean if present)
      4. Add warning if `parallel: true` is used on a for-each phase (not supported - should be used in step workflows only)

      Reference: context/implementation-plan.md section 4.D

  # Step 5: Create Build Parallel Prompt Script
  - prompt: |
      Create new script: scripts/build-parallel-prompt.sh

      This script builds the prompt for parallel tasks spawned in background.

      Parameters:
      - SPRINT_DIR, PHASE_IDX, STEP_IDX, SUB_IDX, TASK_ID

      Output format:
      ```
      # Parallel Task Execution
      Task ID: $TASK_ID

      ## Context
      Step: [step prompt from PROGRESS.yaml]

      ## Your Task: [sub-phase-id]
      [sub-phase prompt from PROGRESS.yaml]

      ## Instructions
      1. Execute this task independently
      2. This runs in background - main workflow continues without waiting
      3. Focus on completing this specific task
      4. Commit changes when done

      Note: Do NOT modify PROGRESS.yaml - the main loop tracks completion via process exit.
      ```

      Reference: context/implementation-plan.md section 4.F

  # Step 6: Update Sprint Loop - Core Logic
  - prompt: |
      Update scripts/sprint-loop.sh with parallel task management:

      Add new helper functions:
      1. is_parallel_subphase() - Check if current sub-phase has parallel flag
      2. spawn_parallel_task() - Spawn task in background, register in PROGRESS.yaml
      3. is_wait_for_parallel_phase() - Check if phase has wait-for-parallel flag
      4. wait_for_parallel_tasks() - Block until all parallel tasks complete
      5. update_parallel_task_statuses() - Poll and update status of running tasks

      Update main loop:
      - When processing sub-phase, check if parallel - if yes, spawn and continue
      - When processing top-level phase, check wait-for-parallel - if yes, wait
      - Call update_parallel_task_statuses() periodically

      Reference: context/implementation-plan.md section 4.E

  # Step 7: Update Build Sprint Prompt Script
  - prompt: |
      Update scripts/build-sprint-prompt.sh to skip parallel sub-phases:

      When building prompts for the main loop, skip sub-phases that:
      - Have status 'spawned' (already running in background)
      - Have parallel-task-id set (reference to parallel-tasks entry)

      This prevents re-executing tasks that are already running in parallel.

      Reference: context/implementation-plan.md section 5 (Files to Modify table)

  # Step 8: Update Sprint Status Command
  - prompt: |
      Update commands/sprint-status.md to display parallel task status:

      Add new section after step/phase display:
      ```
      Parallel Tasks:
      [~] step-0-update-docs-1705123456 (running, 2m elapsed)
          Step: Implement user authentication
          Phase: update-docs
          PID: 12345 | Log: logs/step-0-update-docs-1705123456.log
      [x] step-1-update-docs-1705123789 (completed, 1m 23s)
      ```

      Show:
      - Task ID, status, elapsed time
      - Which step/phase spawned it
      - PID and log file location

      Reference: context/implementation-plan.md section 4.G

  # Step 9: Update Workflow Schema Documentation
  - prompt: |
      Update skills/creating-workflows/references/workflow-schema.md:

      Document new properties:
      1. `parallel?: boolean` on WorkflowPhase
         - Description: Run this phase in background, don't block next step
         - Use case: Documentation updates, learning loops
         - Note: Only works in step workflows, not on for-each phases

      2. `wait-for-parallel?: boolean` on top-level WorkflowPhase
         - Description: Wait for all parallel tasks to complete before continuing
         - Use case: Sync points before QA or deployment phases

      Add usage examples from the plan.

      Reference: context/implementation-plan.md section 5

  # Step 10: Integration Testing
  - prompt: |
      Create integration test for parallel execution:

      1. Create test workflow with parallel sub-phase in step workflow
      2. Create test sprint with 2-3 steps using this workflow
      3. Run compilation and verify:
         - parallel-tasks array is initialized
         - parallel flag propagates to compiled sub-phases
         - wait-for-parallel flag appears on sync phases

      4. Test execution (manual or automated):
         - Verify parallel tasks spawn as background processes
         - Verify main loop advances without waiting
         - Verify wait-for-parallel blocks until completion
         - Check parallel task logs are created
         - Test failure handling (kill a parallel task, check status)

      Reference: context/implementation-plan.md section 8 (Verification Plan)

# Sprint metadata
sprint-id: 2026-01-18_parallel-execution
name: parallel-execution
created: 2026-01-18T00:00:00Z
owner: konstantin

# Configuration
config:
  auto-commit: true
  max-tasks: 10
