# SPRINT.yaml - m42-signs Plugin Implementation
# Full implementation of the learning loop plugin for agent evolution

workflow: gherkin-verified-execution

steps:
  # Phase 1: Foundation
  - prompt: |
      ## Phase 1.1: Plugin Structure Setup

      Create the basic plugin structure for m42-signs:

      ### Tasks
      1. Create .claude-plugin/plugin.json with:
         - Plugin metadata (name: "m42-signs", version: "0.1.0")
         - Author, description, keywords
         - NOTE: Commands and skills are auto-discovered, not declared in plugin.json

      2. Create minimal README.md with:
         - One-line description
         - Installation instructions
         - Link to docs/ for detailed documentation (placeholder for now)

      3. Create directory structure:
         - commands/ (for command definitions)
         - skills/managing-signs/ (skill directory)
           - SKILL.md (main skill file with frontmatter)
           - references/ (reference documentation)
           - assets/ (templates)
         - scripts/ (for utility scripts)
         - docs/ (for user documentation - will be populated later)

      ### Success Criteria
      - Plugin structure follows m42-sprint patterns
      - plugin.json is valid JSON with proper metadata
      - README links to docs/ folder
      - Skill directory has correct structure

  - prompt: |
      ## Phase 1.2: Backlog Schema and Templates

      Create the learning backlog structure:

      ### Tasks
      1. Create skills/managing-signs/assets/backlog-template.yaml with:
         - Schema version
         - Metadata fields (extracted-from, extracted-at)
         - Empty learnings array
         - Example learning entry (commented)

      2. Create skills/managing-signs/references/backlog-schema.md documenting:
         - All fields and their purpose
         - Status enum values (pending, approved, rejected, applied)
         - Confidence levels (low, medium, high)
         - Source metadata structure
         - Include proper frontmatter (title, description, skill)

      3. Create scripts/validate-backlog.sh to:
         - Check YAML syntax
         - Validate required fields
         - Check status values are valid
         - Ensure target paths exist

      ### Success Criteria
      - Template is valid YAML
      - Reference has proper frontmatter and is LLM-optimized (dense, structured)
      - Validation script catches common errors

  - prompt: |
      ## Phase 1.3: Manual Sign Management Commands

      Implement /add, /list, /status commands.

      NOTE: Command files go in commands/ with simple names.
      The plugin namespace is auto-prepended, so:
      - commands/add.md becomes /m42-signs:add
      - commands/list.md becomes /m42-signs:list
      - commands/status.md becomes /m42-signs:status

      ### Tasks
      1. Create commands/add.md:
         - Proper frontmatter (description, allowed-tools, model)
         - Interactive prompts for problem/solution/target
         - Support --direct flag to skip backlog
         - Add learning to backlog.yaml or CLAUDE.md directly
         - Validation of inputs

      2. Create commands/list.md:
         - Find all CLAUDE.md files in project
         - Parse ## Signs sections
         - Display table: Location | Title | Origin
         - Support --format json option

      3. Create commands/status.md:
         - Read .claude/learnings/backlog.yaml
         - Count by status (pending/approved/rejected/applied)
         - Show summary table
         - List pending learnings if any

      4. Create commands/help.md:
         - Overview of all commands (as /m42-signs:<command>)
         - Usage examples
         - Workflow diagram

      ### Success Criteria
      - Commands have proper frontmatter
      - Commands work without backlog.yaml existing
      - Add command validates inputs
      - List finds signs in nested directories
      - Status handles missing backlog gracefully

  # Phase 2: Extraction
  - prompt: |
      ## Phase 2.1: Transcript Parsing Logic

      Implement session transcript parsing:

      ### Tasks
      1. Create scripts/parse-transcript.sh:
         - Read JSONL session file
         - Extract all messages with is_error: true
         - Correlate tool_use with tool_result
         - Output: tool name, command/input, error message

      2. Create skills/managing-signs/references/transcript-format.md:
         - Include proper frontmatter (title, description, skill: managing-signs)
         - Document all message types from SESSION-TRACKING.md
         - Include jq query examples
         - Explain correlation logic
         - Keep it LLM-dense (tables, code examples, no prose)

      3. Test parsing with:
         - Find a real session file in ~/.claude/projects/
         - Run parse-transcript.sh
         - Verify error extraction works

      ### Success Criteria
      - Script handles all message types
      - Errors are correctly correlated with their tool calls
      - Output is structured and parsable
      - Reference file has frontmatter and is dense

  - prompt: |
      ## Phase 2.2: Error Pattern Detection

      Implement retry pattern identification:

      ### Tasks
      1. Create scripts/find-retry-patterns.sh:
         - Input: parsed transcript with errors
         - Detect sequences: error -> retry -> success
         - Extract the diff (what changed between attempts)
         - Group by tool type (Bash, Edit, etc.)

      2. Add heuristics for common patterns:
         - Command syntax fixes (quoting, escaping)
         - File path corrections
         - Permission/access fixes
         - API retry with rate limiting

      3. Create confidence scoring:
         - High: Clear fix, obvious pattern
         - Medium: Plausible fix, moderate evidence
         - Low: Unclear if fix was causal

      ### Success Criteria
      - Script detects at least 80% of retry patterns
      - Confidence scores are reasonable
      - False positives are < 20%

  - prompt: |
      ## Phase 2.3: Target CLAUDE.md Inference

      Implement logic to infer where signs should be stored:

      ### Tasks
      1. Create scripts/infer-target.sh:
         - Input: file paths from tool calls
         - Extract common directory prefix
         - Check for existing CLAUDE.md in hierarchy
         - Suggest target CLAUDE.md path

      2. Add rules:
         - Scripts/automation -> scripts/CLAUDE.md
         - API code -> api/CLAUDE.md
         - General/cross-cutting -> project root CLAUDE.md
         - Tool-specific -> create new CLAUDE.md if needed

      3. Support manual override in extraction

      ### Success Criteria
      - Inference is accurate for 90% of cases
      - Edge cases have reasonable defaults
      - User can override if needed

  - prompt: |
      ## Phase 2.4: Extraction Command

      Implement /m42-signs:extract command:

      ### Tasks
      1. Create commands/extract.md:
         - Proper frontmatter (description, allowed-tools, model)
         - Accept session ID or transcript file path
         - Find session file in ~/.claude/projects/ if ID given
         - Run parsing -> retry detection -> target inference pipeline
         - Generate learning entries in backlog format
         - Write to .claude/learnings/backlog.yaml (append mode)
         - Output summary of proposed learnings

      2. Add options:
         - --dry-run: show what would be extracted
         - --confidence-min: filter by confidence level
         - --auto-approve: skip review for high-confidence

      3. Handle edge cases:
         - No errors found -> "No learnings to extract"
         - Session file not found -> clear error
         - Malformed JSONL -> graceful failure

      ### Success Criteria
      - Extract works with session ID and file path
      - Proposed learnings are reasonable
      - Backlog is properly updated

  # Phase 3: Review & Apply
  - prompt: |
      ## Phase 3.1: Interactive Review Command

      Implement /m42-signs:review command:

      ### Tasks
      1. Create commands/review.md:
         - Proper frontmatter (description, allowed-tools, model)
         - Load .claude/learnings/backlog.yaml
         - Filter to status: pending
         - For each learning:
           - Display: title, problem, solution, target, confidence
           - Show context (origin, source tool/error)
           - Prompt: [A]pprove / [R]eject / [E]dit / [S]kip / [Q]uit
         - Update status based on choice
         - Save changes after each decision

      2. Add edit mode:
         - Allow editing title, problem, solution, target
         - Re-validate edited learning
         - Update confidence if significantly changed

      3. Add batch operations:
         - --approve-all-high: auto-approve high confidence
         - --reject-all-low: auto-reject low confidence

      ### Success Criteria
      - Interactive flow is intuitive
      - Edits are validated before saving
      - Batch operations are safe (with confirmation)

  - prompt: |
      ## Phase 3.2: Apply Command

      Implement /m42-signs:apply command:

      ### Tasks
      1. Create commands/apply.md:
         - Proper frontmatter (description, allowed-tools, model)
         - Load backlog, filter to status: approved
         - Group learnings by target CLAUDE.md
         - For each target:
           - Read or create CLAUDE.md
           - Find or create ## Signs section
           - Append formatted learning entry
           - Update backlog: status -> applied
         - Output summary of applied changes

      2. Create skills/managing-signs/references/claude-md-format.md:
         - Proper frontmatter (title, description, skill: managing-signs)
         - Document sign format
         - Show examples with proper structure
         - Explain origin tracking
         - Keep LLM-dense

      3. Add options:
         - --commit: create git commit after applying
         - --dry-run: show what would be changed
         - --targets: apply only to specific CLAUDE.md files

      ### Success Criteria
      - CLAUDE.md files are properly formatted
      - Signs section is clearly delimited
      - Applied learnings are removed from pending

  - prompt: |
      ## Phase 3.3: Git Integration

      Add optional git commit support:

      ### Tasks
      1. Update commands/apply.md with git logic:
         - After applying changes, offer to commit
         - Commit message format: "signs: apply N learnings"
         - Include list of affected files
         - Support --auto-commit flag

      2. Add safety checks:
         - Verify repo is clean (or at least no conflicts)
         - Stage only CLAUDE.md and backlog.yaml changes
         - Allow user to abort before committing

      3. Handle edge cases:
         - Not in a git repo -> skip git integration
         - User declines commit -> just save changes

      ### Success Criteria
      - Commits are atomic and clear
      - No unrelated changes are included
      - User has full control over committing

  # Phase 4: Sprint Integration
  - prompt: |
      ## Phase 4.1: Sprint Workflow Integration

      Create workflow step template for learning extraction:

      ### Tasks
      1. Create skills/managing-signs/assets/learning-extraction-workflow.yaml:
         - Phase that runs after sprint completion
         - Receives session transcript path
         - Runs extraction with --confidence-min medium
         - Outputs backlog summary

      2. Document integration in skills/managing-signs/SKILL.md:
         - How to add learning extraction to sprint workflows
         - Session transcript variable names
         - Example workflow configurations

      3. Create example in skills/managing-signs/assets/sprint-with-learning.yaml:
         - Complete sprint workflow
         - Includes learning extraction phase
         - Shows how phases connect

      ### Success Criteria
      - Workflow template is valid YAML
      - Integration documentation is clear
      - Example works with m42-sprint

  # Phase 5: Documentation (Final)
  - prompt: |
      ## Phase 5.1: Getting Started Guide

      Create the primary user documentation:

      ### Tasks
      1. Create docs/getting-started.md:
         - Prerequisites (Claude Code installed, plugin enabled)
         - Installation steps
         - First sign in 5 minutes (quick tutorial)
         - Basic workflow: add -> list -> status
         - Link to how-to guides for more

      2. Structure docs/ folder:
         ```
         docs/
           getting-started.md    # Entry point
           how-to/
             add-sign-manually.md
             extract-from-session.md
             review-and-apply.md
             integrate-with-sprint.md
           reference/
             commands.md         # All commands reference
             backlog-format.md   # Schema documentation
         ```

      3. Update README.md:
         - Keep it concise (installation + quick example)
         - Add "Documentation" section with link to docs/getting-started.md
         - Add badges if appropriate

      ### Success Criteria
      - Getting started guide is complete and accurate
      - New user can add their first sign in < 5 minutes
      - docs/ structure is clear and navigable

  - prompt: |
      ## Phase 5.2: How-To Guides

      Create task-oriented how-to guides:

      ### Tasks
      1. Create docs/how-to/add-sign-manually.md:
         - When to add signs manually vs extract
         - Step-by-step with /m42-signs:add
         - Using --direct flag
         - Examples of good sign content

      2. Create docs/how-to/extract-from-session.md:
         - Finding session IDs
         - Running /m42-signs:extract
         - Understanding confidence levels
         - Filtering and dry-run options

      3. Create docs/how-to/review-and-apply.md:
         - The review workflow
         - Editing learnings
         - Batch operations
         - Git commit integration

      4. Create docs/how-to/integrate-with-sprint.md:
         - Adding learning extraction to workflows
         - Automatic vs manual extraction
         - End-of-sprint analysis patterns

      ### Success Criteria
      - Each guide is self-contained and actionable
      - Includes concrete examples
      - Links to related guides where relevant

  - prompt: |
      ## Phase 5.3: Reference Documentation

      Create comprehensive reference docs:

      ### Tasks
      1. Create docs/reference/commands.md:
         - All commands with full syntax
         - All options/flags documented
         - Examples for each command
         - Common errors and solutions

      2. Create docs/reference/backlog-format.md:
         - Complete YAML schema
         - All fields explained
         - Status transitions
         - Example entries

      3. Create docs/reference/sign-format.md:
         - How signs appear in CLAUDE.md
         - Formatting conventions
         - Origin tracking explained

      ### Success Criteria
      - Reference is comprehensive
      - Easy to find specific information
      - Code examples are copy-pasteable

  - prompt: |
      ## Phase 5.4: Final Polish and Testing

      Complete documentation and validate:

      ### Tasks
      1. Update CONCEPT.md:
         - Mark all phases as complete
         - Add link to docs/getting-started.md
         - Document known limitations
         - Add changelog section

      2. Verify documentation:
         - All internal links work
         - Code examples are tested
         - No placeholder text remains

      3. Run full workflow test:
         - Follow getting-started guide as new user
         - Extract from real session
         - Review and approve learnings
         - Apply to test CLAUDE.md
         - Verify signs appear correctly

      4. Update skills/managing-signs/SKILL.md:
         - Proper frontmatter with trigger keywords
         - Link to docs/ for user-facing content
         - Keep skill focused on LLM behavior

      ### Success Criteria
      - Documentation is complete and accurate
      - All commands have been tested via docs
      - Plugin is ready for use

# Sprint metadata
sprint-id: 2026-01-18_m42-signs-implementation
name: m42-signs-implementation
created: 2026-01-18T00:45:59+01:00
description: Full implementation of the m42-signs learning loop plugin
target: plugins/m42-signs/
