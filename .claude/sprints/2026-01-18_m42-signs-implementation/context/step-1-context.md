# Step Context: step-1

## Task
## Phase 1.2: Backlog Schema and Templates

Create the learning backlog structure:

### Tasks
1. Create skills/managing-signs/assets/backlog-template.yaml with:
   - Schema version
   - Metadata fields (extracted-from, extracted-at)
   - Empty learnings array
   - Example learning entry (commented)

2. Create skills/managing-signs/references/backlog-schema.md documenting:
   - All fields and their purpose
   - Status enum values (pending, approved, rejected, applied)
   - Confidence levels (low, medium, high)
   - Source metadata structure
   - Include proper frontmatter (title, description, skill)

3. Create scripts/validate-backlog.sh to:
   - Check YAML syntax
   - Validate required fields
   - Check status values are valid
   - Ensure target paths exist

### Success Criteria
- Template is valid YAML
- Reference has proper frontmatter and is LLM-optimized (dense, structured)
- Validation script catches common errors


## Related Code Patterns

### Similar Implementation: plugins/m42-sprint/skills/orchestrating-sprints/assets/progress-template.yaml
```yaml
# PROGRESS.yaml - Compiled Sprint Progress
# Generated by: node compiler/dist/index.js <sprint-dir>

sprint-id: YYYY-MM-DD_sprint-name
status: not-started

# Compiled phase hierarchy
phases:
  # Simple phase
  - id: prepare
    status: pending
    prompt: "Sprint preparation tasks..."
```
**Pattern**: YAML templates use comments for documentation, top-level metadata fields first, then arrays/complex structures.

### Similar Implementation: plugins/m42-sprint/skills/creating-sprints/references/sprint-schema.md
```markdown
---
title: Sprint Schema Reference
description: Complete YAML schema for SPRINT.yaml definitions including all fields, types, and validation rules.
keywords: sprint, schema, yaml, steps, validation, types, SPRINT.yaml
skill: creating-sprints
---

# Sprint Schema Reference

## File Structure

Sprint files are YAML documents stored in sprint directories.

## Top-Level Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | No | Human-readable sprint name |
...
```
**Pattern**: Reference docs use tables for field documentation, TypeScript interfaces for formal specification, validation rules section, examples section with valid/invalid cases.

### Similar Implementation: plugins/m42-sprint/scripts/preflight-check.sh
```bash
#!/bin/bash
set -euo pipefail

SPRINT_DIR="$1"
if [[ -z "$SPRINT_DIR" ]] || [[ ! -d "$SPRINT_DIR" ]]; then
  echo "Error: Valid sprint directory required" >&2
  exit 1
fi

ERRORS=()

# Check 1: Required tools
if ! command -v yq &> /dev/null; then
  ERRORS+=("Required tool 'yq' is not installed")
fi

# Validate YAML
if ! yq -e '.' "$FILE" > /dev/null 2>&1; then
  ERRORS+=("File is corrupted or invalid YAML")
fi

# Report results
if [[ ${#ERRORS[@]} -eq 0 ]]; then
  echo "Validation passed."
  exit 0
else
  echo "Validation FAILED:"
  for err in "${ERRORS[@]}"; do
    echo "  - $err"
  done
  exit 1
fi
```
**Pattern**: Validation scripts use `set -euo pipefail`, error accumulation array, multiple validation passes, clear output messages.

## Required Imports
### Internal
- None (pure Markdown/YAML/Shell, no TypeScript)

### External
- `yq`: YAML parsing and validation in shell scripts
- Standard bash utilities

## Types/Interfaces to Use
From shared context (`_shared-context.md`):

```yaml
# Backlog Schema (YAML)
version: 1
extracted-from: <session-id or sprint-id>
extracted-at: <ISO timestamp>

learnings:
  - id: kebab-case-id
    status: pending | approved | rejected | applied
    title: Short description
    problem: |
      Multi-line description of what went wrong
    solution: |
      Multi-line description of how to fix/avoid
    target: path/to/CLAUDE.md
    confidence: low | medium | high
    source:
      tool: <tool name>
      command: <command that failed>
      error: <error message>
```

From CONCEPT.md detailed schema:
```yaml
learnings:
  - id: yq-variable-quoting
    status: pending              # pending | approved | rejected | applied
    title: Quote Variables in yq Expressions
    problem: |
      yq commands fail silently when shell variables aren't quoted.
    solution: |
      Use shell quote escape pattern.
    target: scripts/CLAUDE.md
    confidence: high
    source:
      tool: Bash
      command: "yq '.phases[$IDX].status' PROGRESS.yaml"
      error: "returned empty string"
```

## Integration Points
- **Called by**: `/m42-signs:extract` command (creates new backlog entries)
- **Calls**: None (templates are consumed by commands)
- **Validation**: `validate-backlog.sh` used by commands before processing
- **Tests**: No formal tests; Gherkin scenarios verify (8 scenarios in step-1-gherkin.md)

## File Locations
| File | Path |
|------|------|
| Backlog template | `plugins/m42-signs/skills/managing-signs/assets/backlog-template.yaml` |
| Schema reference | `plugins/m42-signs/skills/managing-signs/references/backlog-schema.md` |
| Validation script | `plugins/m42-signs/scripts/validate-backlog.sh` |
| User backlogs | `.claude/learnings/backlog.yaml` (per-project) |

## Implementation Notes
- Template must be valid YAML (verified by `yq eval '.'`)
- Template needs `learnings` as sequence type (verified by `yq eval -e '.learnings | type == "!!seq"'`)
- Comments for example learning must start with `#` and include `id:` and `status:` patterns
- Reference frontmatter requires: `title`, `description` (required); `keywords`, `skill` (recommended)
- Validation script must:
  - Accept file path as argument
  - Check yq is installed
  - Validate YAML syntax with yq
  - Check required fields: `version`, `extracted-from`, `extracted-at`, `learnings`
  - Validate status values against enum: `pending`, `approved`, `rejected`, `applied`
  - Return exit code 0 on success, non-zero on failure
- Reference doc should use tables for fields (LLM-optimized pattern)
- Follow existing m42-sprint schema reference pattern for consistency

## Gherkin Verification Commands
From step-1-gherkin.md:
```bash
# Scenario 1: YAML validity
yq eval '.' .../backlog-template.yaml > /dev/null 2>&1

# Scenario 2: Required fields
yq eval -e '.version != null and .["extracted-from"] != null and .["extracted-at"] != null and .learnings != null' ...

# Scenario 3: Learnings array type
yq eval -e '.learnings | type == "!!seq"' ...

# Scenario 4: Commented example
grep -q "^#.*id:" ... && grep -q "^#.*status:" ...

# Scenario 5: Reference frontmatter
grep -q "^title:" ... && grep -q "^description:" ...

# Scenario 6: Status enum documented
grep -q "pending" ... && grep -q "approved" ... && grep -q "rejected" ... && grep -q "applied" ...

# Scenario 7: Script executable
test -x .../validate-backlog.sh

# Scenario 8: Script validates template
./validate-backlog.sh .../backlog-template.yaml
```
