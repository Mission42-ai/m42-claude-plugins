# SPRINT.yaml - Worktree-Parallel Sprint Support
# Enable multiple sprints to run concurrently across git worktrees
# with automatic worktree creation and native execution

workflow: plugin-development

# Worktree configuration for THIS sprint (example of the feature we're building)
# worktree:
#   enabled: true
#   branch: sprint/worktree-parallel-sprints
#   path: ../m42-plugins-worktree-parallel  # relative to repo root

steps:
  # ============================================================================
  # Step 0: Worktree Configuration Schema
  # ============================================================================
  - id: worktree-config-schema
    prompt: |
      GIVEN the need to optionally run sprints in dedicated worktrees
      WHEN users define a sprint or workflow
      THEN provide configuration options for automatic worktree creation

      ## Scope
      Define the schema for worktree configuration at workflow and sprint levels.

      ## Acceptance Criteria

      ### SPRINT.yaml Schema Extension
      Add optional `worktree` configuration block:
      ```yaml
      # SPRINT.yaml
      workflow: my-workflow

      # Optional: Automatic worktree for this sprint
      worktree:
        enabled: true                              # Enable dedicated worktree
        branch: sprint/{sprint-id}                 # Branch name (supports variables)
        path: ../{sprint-id}-worktree              # Worktree path (relative to repo)
        cleanup: on-complete                       # never | on-complete | on-merge
      ```

      ### Workflow-level Defaults
      Workflows can set default worktree behavior:
      ```yaml
      # workflows/feature-development.yaml
      name: feature-development
      worktree:
        enabled: true                              # All sprints using this workflow
        branch-prefix: sprint/                     # Default branch prefix
        path-prefix: ../worktrees/                 # Default worktree location
        cleanup: on-complete
      ```

      ### Sprint Overrides Workflow
      - [ ] Sprint-level `worktree` config overrides workflow defaults
      - [ ] `enabled: false` in sprint disables even if workflow enables
      - [ ] Missing config = inherit from workflow or disabled

      ### Variable Substitution
      Support these variables in branch/path:
      - `{sprint-id}` → e.g., `2026-01-20_feature-auth`
      - `{sprint-name}` → e.g., `feature-auth`
      - `{date}` → e.g., `2026-01-20`
      - `{workflow}` → e.g., `feature-development`

      ### Type Definitions
      ```typescript
      interface WorktreeConfig {
        enabled: boolean;
        branch?: string;        // Default: sprint/{sprint-id}
        path?: string;          // Default: ../{sprint-id}-worktree
        cleanup?: 'never' | 'on-complete' | 'on-merge';
      }
      ```

      ### Validation Rules
      - [ ] Branch name must be valid git ref
      - [ ] Path must not conflict with existing directories
      - [ ] Cleanup mode validated against enum

      ## Files to Modify
      - plugins/m42-sprint/compiler/src/types.ts (add WorktreeConfig)
      - plugins/m42-sprint/compiler/src/schema.ts (validation)

  # ============================================================================
  # Step 1: Automatic Worktree Creation at Sprint Start
  # ============================================================================
  - id: auto-worktree-creation
    prompt: |
      GIVEN the worktree configuration schema from Step 0
      WHEN a user runs /start-sprint with worktree enabled
      THEN automatically create git branch and worktree

      ## Scope
      Modify /start-sprint to create worktree when configured.

      ## Acceptance Criteria

      ### Branch Creation
      - [ ] Create new branch from current HEAD (or specified base)
      - [ ] Branch name from config with variable substitution
      - [ ] Fail gracefully if branch already exists (offer to reuse)

      ### Worktree Creation
      - [ ] Run `git worktree add <path> <branch>`
      - [ ] Path from config with variable substitution
      - [ ] Create parent directories if needed
      - [ ] Validate path doesn't already exist

      ### Sprint Directory Setup
      - [ ] Create .claude/sprints/{sprint-id}/ in the NEW worktree
      - [ ] Copy SPRINT.yaml to worktree's sprint directory
      - [ ] Initialize PROGRESS.yaml with worktree metadata

      ### PROGRESS.yaml Worktree Fields
      ```yaml
      worktree:
        enabled: true
        branch: sprint/feature-auth
        path: /absolute/path/to/worktree
        working-dir: /absolute/path/to/worktree  # Where Claude executes
        created-at: 2026-01-20T10:00:00Z
        cleanup: on-complete
      ```

      ### User Feedback
      ```
      Creating dedicated worktree for sprint...

      Branch: sprint/feature-auth (created from main)
      Worktree: /home/user/project-feature-auth
      Sprint Dir: /home/user/project-feature-auth/.claude/sprints/2026-01-20_feature-auth

      Sprint initialized in worktree. Run:
        cd /home/user/project-feature-auth
        /run-sprint .claude/sprints/2026-01-20_feature-auth
      ```

      ### Error Handling
      - [ ] Branch exists → offer to checkout existing or create new name
      - [ ] Directory exists → fail with clear message
      - [ ] Git errors → show git output, suggest manual steps

      ## Files to Modify
      - plugins/m42-sprint/commands/start-sprint.md
      - plugins/m42-sprint/runtime/src/worktree.ts (new: createWorktree())

  # ============================================================================
  # Step 2: Runtime Execution Directory (Critical)
  # ============================================================================
  - id: runtime-working-dir
    prompt: |
      GIVEN that Claude currently executes with cwd=sprintDir (.claude/sprints/xxx/)
      WHEN users expect Claude to operate naturally in the codebase
      THEN change runtime to execute Claude from project/worktree root

      ## Scope
      **CRITICAL**: Modify the sprint runtime to execute Claude from the correct directory.

      ## The Problem
      Current behavior in loop.ts:
      ```typescript
      const spawnResult = await deps.runClaude({
        prompt,
        cwd: sprintDir,  // ← This is .claude/sprints/2026-01-20_feature/
        outputFile,
      });
      ```

      Claude thinks it's in the sprint metadata folder, not the project!

      ## The Solution
      ```typescript
      const spawnResult = await deps.runClaude({
        prompt,
        cwd: progress.worktree?.['working-dir'] ?? getProjectRoot(sprintDir),
        outputFile,
      });
      ```

      ## Acceptance Criteria

      ### working-dir Field in PROGRESS.yaml
      - [ ] Add `working-dir` field (absolute path where Claude executes)
      - [ ] For worktree sprints: worktree root
      - [ ] For non-worktree sprints: project root (git root or cwd)
      - [ ] Populated by compiler/start-sprint

      ### Project Root Detection
      - [ ] `getProjectRoot(sprintDir)` → finds git root or falls back
      - [ ] Respects worktree boundaries (doesn't escape to main repo)
      - [ ] Handles non-git directories gracefully

      ### Runtime Changes (loop.ts)
      - [ ] Read `working-dir` from PROGRESS.yaml
      - [ ] Pass as `cwd` to runClaude()
      - [ ] Sprint directory still used for PROGRESS.yaml writes
      - [ ] Transcriptions still written to sprint directory

      ### Path Handling
      - [ ] All file paths in prompts work relative to working-dir
      - [ ] Absolute paths still work
      - [ ] Sprint-relative paths (for artifacts) documented

      ### Backwards Compatibility
      - [ ] If `working-dir` missing, fall back to getProjectRoot()
      - [ ] Existing sprints continue to work

      ### Test Cases
      - [ ] Sprint without worktree: cwd = project root
      - [ ] Sprint with worktree: cwd = worktree root
      - [ ] File operations work naturally (Read, Write, Edit)
      - [ ] Git operations work in correct directory

      ## Files to Modify
      - plugins/m42-sprint/runtime/src/loop.ts (cwd change)
      - plugins/m42-sprint/runtime/src/worktree.ts (getProjectRoot)
      - plugins/m42-sprint/compiler/src/types.ts (working-dir field)
      - plugins/m42-sprint/compiler/src/compiler.ts (populate working-dir)

  # ============================================================================
  # Step 3: Worktree Detection & Isolation
  # ============================================================================
  - id: worktree-detection
    prompt: |
      GIVEN the runtime now executes in project/worktree root
      WHEN multiple developers want to run sprints in parallel across worktrees
      THEN add worktree awareness and isolation to prevent conflicts

      ## Scope
      Enhance sprint initialization and execution to detect and isolate by worktree.

      ## Acceptance Criteria

      ### Worktree Detection
      - [ ] Detect if running in a git worktree
      - [ ] Get worktree root path (not just repo root)
      - [ ] Generate unique worktree identifier (hash of worktree path)

      ### PROGRESS.yaml Enhancement
      - [ ] Add `worktree-id` field to PROGRESS.yaml
      - [ ] Add `worktree-path` field for debugging
      - [ ] Automatically populate on sprint start

      ### Isolation Validation
      - [ ] Verify .claude/sprints/ is local to each worktree
      - [ ] Verify PROGRESS.yaml writes are worktree-local
      - [ ] Test: same sprint name in two worktrees = two separate sprints

      ### Helper Functions
      - [ ] `getWorktreeInfo()` → { isWorktree, path, id, mainWorktreePath }
      - [ ] `validateWorktreeIsolation()` → boolean

      ### Tests
      - [ ] Unit test: worktree detection logic
      - [ ] Integration test: two worktrees, same sprint name, separate execution

      ## Files to Modify/Create
      - plugins/m42-sprint/compiler/src/types.ts (add worktree fields)
      - plugins/m42-sprint/runtime/src/worktree.ts (detection helpers)
      - plugins/m42-sprint/runtime/src/worktree.test.ts

  # ============================================================================
  # Step 4: Sprint Status Multi-Worktree View
  # ============================================================================
  - id: status-multi-worktree
    prompt: |
      GIVEN the worktree isolation from Step 3
      WHEN users want to monitor all active sprints across worktrees
      THEN create a unified status view

      ## Scope
      Extend /sprint-status command to show sprints across all worktrees.

      ## Acceptance Criteria

      ### Command Enhancement
      - [ ] Add `--all-worktrees` flag to /sprint-status
      - [ ] Discover all worktrees in repository
      - [ ] Read PROGRESS.yaml from each worktree's .claude/sprints/

      ### Status Display
      - [ ] Show worktree path for each sprint
      - [ ] Show worktree-id for verification
      - [ ] Indicate current worktree with marker (*)
      - [ ] Color-code by status (in-progress=yellow, completed=green, etc.)

      ### Output Format
      ```
      Active Sprints Across Worktrees
      ================================

      * /home/user/project-main/.claude/sprints/2026-01-20_feature-a/
        Worktree: main (current)
        Working Dir: /home/user/project-main
        Status: in-progress
        Phase: 3/8 (development)

        /home/user/project-worktree1/.claude/sprints/2026-01-20_feature-b/
        Worktree: feature-branch
        Working Dir: /home/user/project-worktree1
        Status: in-progress
        Phase: 1/8 (preflight)

      Total: 2 active sprints
      ```

      ### Error Handling
      - [ ] Handle worktrees with no sprints gracefully
      - [ ] Handle corrupted PROGRESS.yaml files
      - [ ] Skip worktrees with permission errors

      ### Tests
      - [ ] Test: discover sprints in multiple worktrees
      - [ ] Test: filter to current worktree only (default behavior)
      - [ ] Test: --all-worktrees flag shows all

      ## Files to Modify
      - plugins/m42-sprint/commands/sprint-status.md
      - plugins/m42-sprint/runtime/src/status.ts (or relevant status module)

  # ============================================================================
  # Step 5: Conflict Detection & Prevention
  # ============================================================================
  - id: conflict-prevention
    prompt: |
      GIVEN sprints running in multiple worktrees
      WHEN operations could conflict (shared resources, git operations)
      THEN detect and prevent conflicts

      ## Scope
      Add conflict detection for operations that touch shared state.

      ## Acceptance Criteria

      ### Shared Resource Detection
      - [ ] Identify shared resources: git config, shared branches, global state
      - [ ] Lock mechanism for git operations (branch creation, commits)
      - [ ] Detect if another sprint is modifying same branch

      ### Git Operation Safety
      - [ ] Check if sprint branch already exists in another worktree
      - [ ] Warn before creating branch with same name
      - [ ] Suggest branch name with worktree suffix if conflict

      ### Lock Files
      - [ ] Create .sprint-locks/ directory in repo root (shared across worktrees)
      - [ ] Lock format: {operation}-{worktree-id}.lock
      - [ ] Auto-cleanup stale locks (older than 1 hour)

      ### Conflict Messages
      ```
      Warning: Sprint "feature-auth" is already running in another worktree:
        Worktree: /home/user/project-main
        Branch: sprint/feature-auth
        Status: in-progress

      Suggestions:
        1. Use a different sprint name: /start-sprint feature-auth-v2
        2. Stop the other sprint first: cd /path && /stop-sprint
        3. Continue anyway (not recommended): --force
      ```

      ### Tests
      - [ ] Test: detect branch conflict across worktrees
      - [ ] Test: lock acquisition and release
      - [ ] Test: stale lock cleanup

      ## Files to Create
      - plugins/m42-sprint/runtime/src/locks.ts
      - plugins/m42-sprint/runtime/src/locks.test.ts

  # ============================================================================
  # Step 6: Worktree Cleanup on Sprint Completion
  # ============================================================================
  - id: worktree-cleanup
    prompt: |
      GIVEN sprints that created dedicated worktrees
      WHEN the sprint completes or is explicitly cleaned up
      THEN handle worktree lifecycle based on configuration

      ## Scope
      Implement cleanup strategies for sprint worktrees.

      ## Acceptance Criteria

      ### Cleanup Modes
      - `never`: Worktree persists indefinitely
      - `on-complete`: Remove worktree when sprint status = completed
      - `on-merge`: Remove after branch is merged to main

      ### Cleanup Command
      - [ ] Add /cleanup-sprint command
      - [ ] Options: --force (skip confirmation), --keep-branch

      ### Automatic Cleanup
      - [ ] On sprint completion, check cleanup config
      - [ ] If `on-complete`, prompt user or auto-cleanup
      - [ ] Log cleanup actions

      ### Cleanup Steps
      1. Verify sprint is in terminal state (completed/blocked)
      2. Check for uncommitted changes in worktree
      3. Remove worktree: `git worktree remove <path>`
      4. Optionally delete branch: `git branch -d <branch>`
      5. Archive sprint directory (optional)

      ### Safety Checks
      - [ ] Never delete worktree with uncommitted changes
      - [ ] Never delete worktree if sprint is in-progress
      - [ ] Require --force for worktrees with unpushed commits

      ### User Feedback
      ```
      Sprint completed. Cleaning up worktree...

      Worktree: /home/user/project-feature-auth
      Branch: sprint/feature-auth
      Status: completed

      Actions:
        [x] Worktree removed
        [x] Branch deleted (was merged to main)
        [x] Sprint archived to .claude/sprints/archive/
      ```

      ## Files to Create/Modify
      - plugins/m42-sprint/commands/cleanup-sprint.md (new)
      - plugins/m42-sprint/runtime/src/cleanup.ts (new)

  # ============================================================================
  # Step 7: Documentation & User Guide
  # ============================================================================
  - id: documentation
    prompt: |
      GIVEN the new worktree-parallel features
      WHEN users want to understand and use this feature
      THEN provide comprehensive documentation

      ## Scope
      Document worktree-parallel sprint usage patterns.

      ## Acceptance Criteria

      ### User Guide Section
      - [ ] Create docs/guides/parallel-development-worktrees.md
      - [ ] Explain worktree setup for parallel sprints
      - [ ] Provide example workflows
      - [ ] Document limitations and best practices

      ### Configuration Reference
      - [ ] Document worktree config in SPRINT.yaml
      - [ ] Document workflow-level defaults
      - [ ] Document variable substitution

      ### Example Workflows
      ```markdown
      ## Workflow: Automatic Worktree Sprint

      ### Configure Workflow with Worktree Defaults
      ```yaml
      # workflows/feature-development.yaml
      name: feature-development
      worktree:
        enabled: true
        branch-prefix: sprint/
        cleanup: on-complete
      ```

      ### Start Sprint (Worktree Created Automatically)
      ```bash
      /start-sprint feature-auth --workflow feature-development

      # Output:
      # Creating dedicated worktree for sprint...
      # Branch: sprint/feature-auth (created from main)
      # Worktree: ../feature-auth-worktree
      #
      # To run the sprint:
      #   cd ../feature-auth-worktree
      #   /run-sprint .claude/sprints/2026-01-20_feature-auth
      ```

      ### Run Sprint in Worktree
      ```bash
      cd ../feature-auth-worktree
      /run-sprint .claude/sprints/2026-01-20_feature-auth

      # Claude now operates in the worktree directory
      # All file operations are relative to worktree root
      ```
      ```

      ### Troubleshooting Section
      - [ ] What to do if worktree creation fails
      - [ ] How to manually clean up orphaned worktrees
      - [ ] How to recover from interrupted sprints

      ## Files to Create/Modify
      - plugins/m42-sprint/docs/guides/worktree-sprints.md (new)
      - plugins/m42-sprint/docs/reference/sprint-yaml.md (update)

  # ============================================================================
  # Step 8: Integration Tests
  # ============================================================================
  - id: integration-tests
    prompt: |
      GIVEN all worktree-parallel features implemented
      WHEN validating end-to-end functionality
      THEN create comprehensive integration tests

      ## Scope
      Test real-world parallel sprint scenarios.

      ## Acceptance Criteria

      ### Test Scenarios
      - [ ] Sprint with worktree: auto-creates branch and worktree
      - [ ] Sprint without worktree: uses project root as cwd
      - [ ] Two worktrees, different sprints, run concurrently
      - [ ] Sprint status shows all worktrees correctly
      - [ ] Worktree cleanup works after completion
      - [ ] Conflict detection prevents branch name collisions

      ### Runtime Execution Tests
      - [ ] Claude executes in worktree root (not sprint dir)
      - [ ] File operations work relative to worktree
      - [ ] Git operations affect worktree's branch
      - [ ] PROGRESS.yaml still written to sprint directory

      ### Test Setup
      - [ ] Create temporary git repo
      - [ ] Initialize sprint with worktree config
      - [ ] Verify worktree created correctly
      - [ ] Run sprint, verify cwd is worktree
      - [ ] Complete sprint, verify cleanup

      ### Test Scripts
      - [ ] plugins/m42-sprint/scripts/test-worktree-creation.sh
      - [ ] plugins/m42-sprint/scripts/test-runtime-cwd.sh
      - [ ] plugins/m42-sprint/scripts/test-worktree-cleanup.sh

      ## Files to Create
      - plugins/m42-sprint/scripts/test-worktree-creation.sh
      - plugins/m42-sprint/scripts/test-runtime-cwd.sh
      - plugins/m42-sprint/scripts/test-worktree-cleanup.sh

# Sprint metadata
sprint-id: 2026-01-20_worktree-parallel-sprints
name: worktree-parallel-sprints
created: 2026-01-20T12:00:00Z
