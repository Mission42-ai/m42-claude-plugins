# SPRINT.yaml - Worktree-Parallel Sprint Support
# Enable multiple sprints to run concurrently across git worktrees

workflow: plugin-development

steps:
  # ============================================================================
  # Step 0: Worktree Detection & Isolation
  # ============================================================================
  - id: worktree-detection
    prompt: |
      GIVEN the current sprint system that operates on a single working directory
      WHEN multiple developers want to run sprints in parallel across worktrees
      THEN add worktree awareness and isolation to prevent conflicts

      ## Scope
      Enhance sprint initialization and execution to detect and isolate by worktree.

      ## Acceptance Criteria

      ### Worktree Detection
      - [ ] Detect if running in a git worktree
      - [ ] Get worktree root path (not just repo root)
      - [ ] Generate unique worktree identifier (hash of worktree path)

      ### PROGRESS.yaml Enhancement
      - [ ] Add `worktree-id` field to PROGRESS.yaml
      - [ ] Add `worktree-path` field for debugging
      - [ ] Automatically populate on sprint start

      ### Isolation Validation
      - [ ] Verify .claude/sprints/ is local to each worktree
      - [ ] Verify PROGRESS.yaml writes are worktree-local
      - [ ] Test: same sprint name in two worktrees = two separate sprints

      ### Helper Functions
      - [ ] `getWorktreeInfo()` → { isWorktree, path, id }
      - [ ] `validateWorktreeIsolation()` → boolean

      ### Tests
      - [ ] Unit test: worktree detection logic
      - [ ] Integration test: two worktrees, same sprint name, separate execution

      ## Context
      Problem: Users want to run multiple sprints concurrently in different worktrees.
      Current behavior: No worktree awareness, potential file conflicts.

      ## Files to Modify/Create
      - plugins/m42-sprint/compiler/src/types.ts (add worktree fields)
      - plugins/m42-sprint/runtime/src/worktree.ts (new module)
      - plugins/m42-sprint/runtime/src/worktree.test.ts

  # ============================================================================
  # Step 1: Sprint Status Multi-Worktree View
  # ============================================================================
  - id: status-multi-worktree
    prompt: |
      GIVEN the worktree isolation from Step 0
      WHEN users want to monitor all active sprints across worktrees
      THEN create a unified status view

      ## Scope
      Extend /sprint-status command to show sprints across all worktrees.

      ## Acceptance Criteria

      ### Command Enhancement
      - [ ] Add `--all-worktrees` flag to /sprint-status
      - [ ] Discover all worktrees in repository
      - [ ] Read PROGRESS.yaml from each worktree's .claude/sprints/

      ### Status Display
      - [ ] Show worktree path for each sprint
      - [ ] Show worktree-id for verification
      - [ ] Indicate current worktree with marker (*)
      - [ ] Color-code by status (in-progress=yellow, completed=green, etc.)

      ### Output Format
      ```
      Active Sprints Across Worktrees
      ================================

      * /home/user/project-main/.claude/sprints/2026-01-20_feature-a/
        Worktree: main (current)
        Status: in-progress
        Phase: 3/8 (development)

        /home/user/project-worktree1/.claude/sprints/2026-01-20_feature-b/
        Worktree: feature-branch
        Status: in-progress
        Phase: 1/8 (preflight)

      Total: 2 active sprints
      ```

      ### Error Handling
      - [ ] Handle worktrees with no sprints gracefully
      - [ ] Handle corrupted PROGRESS.yaml files
      - [ ] Skip worktrees with permission errors

      ### Tests
      - [ ] Test: discover sprints in multiple worktrees
      - [ ] Test: filter to current worktree only (default behavior)
      - [ ] Test: --all-worktrees flag shows all

      ## Files to Modify
      - plugins/m42-sprint/commands/sprint-status.md
      - plugins/m42-sprint/runtime/src/status.ts (or relevant status module)

  # ============================================================================
  # Step 2: Conflict Detection & Prevention
  # ============================================================================
  - id: conflict-prevention
    prompt: |
      GIVEN sprints running in multiple worktrees
      WHEN operations could conflict (shared resources, git operations)
      THEN detect and prevent conflicts

      ## Scope
      Add conflict detection for operations that touch shared state.

      ## Acceptance Criteria

      ### Shared Resource Detection
      - [ ] Identify shared resources: git config, shared branches, global state
      - [ ] Lock mechanism for git operations (branch creation, commits)
      - [ ] Detect if another sprint is modifying same branch

      ### Git Operation Safety
      - [ ] Check if sprint branch already exists in another worktree
      - [ ] Warn before creating branch with same name
      - [ ] Suggest branch name with worktree suffix if conflict

      ### Lock Files
      - [ ] Create .sprint-locks/ directory in repo root (shared across worktrees)
      - [ ] Lock format: {operation}-{worktree-id}.lock
      - [ ] Auto-cleanup stale locks (older than 1 hour)

      ### Conflict Messages
      ```
      Warning: Sprint "feature-auth" is already running in another worktree:
        Worktree: /home/user/project-main
        Branch: sprint/feature-auth
        Status: in-progress

      Suggestions:
        1. Use a different sprint name: /start-sprint feature-auth-v2
        2. Stop the other sprint first: cd /path && /stop-sprint
        3. Continue anyway (not recommended): --force
      ```

      ### Tests
      - [ ] Test: detect branch conflict across worktrees
      - [ ] Test: lock acquisition and release
      - [ ] Test: stale lock cleanup

      ## Files to Create
      - plugins/m42-sprint/runtime/src/locks.ts
      - plugins/m42-sprint/runtime/src/locks.test.ts

  # ============================================================================
  # Step 3: Documentation & User Guide
  # ============================================================================
  - id: documentation
    prompt: |
      GIVEN the new worktree-parallel features
      WHEN users want to understand and use this feature
      THEN provide comprehensive documentation

      ## Scope
      Document worktree-parallel sprint usage patterns.

      ## Acceptance Criteria

      ### User Guide Section
      - [ ] Create docs/guides/parallel-development-worktrees.md
      - [ ] Explain worktree setup for parallel sprints
      - [ ] Provide example workflows
      - [ ] Document limitations and best practices

      ### Getting Started Addition
      - [ ] Add "Parallel Development" section to quickstart
      - [ ] Show how to set up multiple worktrees
      - [ ] Example: /start-sprint in each worktree

      ### Reference Updates
      - [ ] Document --all-worktrees flag
      - [ ] Document worktree-id field in PROGRESS.yaml
      - [ ] Document conflict detection behavior

      ### Example Workflows
      ```markdown
      ## Workflow: Feature Development in Parallel

      ### Setup Worktrees
      bash
      # Main development
      cd ~/project
      git worktree add ../project-feature-a feature-a
      git worktree add ../project-feature-b feature-b


      ### Start Parallel Sprints
      bash
      # Terminal 1
      cd ~/project-feature-a
      /start-sprint feature-a-implementation
      /run-sprint .claude/sprints/2026-01-20_feature-a-implementation

      # Terminal 2
      cd ~/project-feature-b
      /start-sprint feature-b-implementation
      /run-sprint .claude/sprints/2026-01-20_feature-b-implementation


      ### Monitor All Sprints
      bash
      /sprint-status --all-worktrees

      ```

      ### Troubleshooting Section
      - [ ] What to do if sprint conflicts detected
      - [ ] How to clean up stale locks
      - [ ] How to manually isolate worktree state

      ## Files to Create/Modify
      - plugins/m42-sprint/docs/guides/parallel-development-worktrees.md (new)
      - plugins/m42-sprint/docs/getting-started/quick-start.md (update)
      - plugins/m42-sprint/docs/reference/commands.md (update)

  # ============================================================================
  # Step 4: Integration Tests
  # ============================================================================
  - id: integration-tests
    prompt: |
      GIVEN all worktree-parallel features implemented
      WHEN validating end-to-end functionality
      THEN create comprehensive integration tests

      ## Scope
      Test real-world parallel sprint scenarios.

      ## Acceptance Criteria

      ### Test Scenarios
      - [ ] Two worktrees, different sprints, run concurrently
      - [ ] Two worktrees, same sprint name, isolated execution
      - [ ] Sprint status shows all worktrees correctly
      - [ ] Conflict detection prevents branch name collisions
      - [ ] Lock cleanup works after abnormal termination

      ### Test Setup
      - [ ] Create temporary git repo with worktrees
      - [ ] Initialize sprints in each worktree
      - [ ] Run concurrent operations
      - [ ] Verify isolation and correctness

      ### Test Cleanup
      - [ ] Remove temporary worktrees
      - [ ] Clean up test repositories
      - [ ] Verify no leaked state

      ### Test Scripts
      - [ ] plugins/m42-sprint/scripts/test-worktree-isolation.sh
      - [ ] plugins/m42-sprint/scripts/test-parallel-sprints.sh
      - [ ] plugins/m42-sprint/scripts/test-conflict-detection.sh

      ## Files to Create
      - plugins/m42-sprint/scripts/test-worktree-isolation.sh
      - plugins/m42-sprint/scripts/test-parallel-sprints.sh
      - plugins/m42-sprint/scripts/test-conflict-detection.sh

# Sprint metadata
sprint-id: 2026-01-20_worktree-parallel-sprints
name: worktree-parallel-sprints
created: 2026-01-20T12:00:00Z
