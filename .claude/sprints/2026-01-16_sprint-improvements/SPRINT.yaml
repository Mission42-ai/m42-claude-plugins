workflow: flat-foreach

steps:
  - prompt: |
      Add phase-level timing to the sprint system.

      ## Requirements
      - Track `started-at` and `completed-at` timestamps for each phase
      - Track `elapsed` duration for each phase (format: "HH:MM:SS")
      - Update compiler types in `plugins/m42-sprint/compiler/src/types.ts`
      - Update the build-sprint-prompt.sh script to set `started-at` when beginning a phase
      - Update the sprint-loop.sh to calculate and set `elapsed` when phase completes

      ## Files to modify
      - plugins/m42-sprint/compiler/src/types.ts
      - plugins/m42-sprint/scripts/build-sprint-prompt.sh
      - plugins/m42-sprint/scripts/sprint-loop.sh

  - prompt: |
      Add empty workflow validation to the compiler.

      ## Requirements
      - Fail compilation if a workflow has zero phases
      - Add error code `EMPTY_WORKFLOW` to validation
      - Add validation in `validate.ts` for workflows with empty phases array
      - Write a test case to verify this validation works

      ## Files to modify
      - plugins/m42-sprint/compiler/src/validate.ts
      - plugins/m42-sprint/compiler/src/types.ts (if new error code needed)

  - prompt: |
      Improve YAML error messages with line numbers and context.

      ## Requirements
      - When SPRINT.yaml or workflow files fail to parse, show:
        - The line number where the error occurred
        - A snippet of the problematic YAML (2-3 lines of context)
        - A clear description of what's wrong
      - Use js-yaml's error properties (mark.line, mark.column, mark.snippet)
      - Update error handling in compile.ts and resolve-workflows.ts

      ## Files to modify
      - plugins/m42-sprint/compiler/src/compile.ts
      - plugins/m42-sprint/compiler/src/resolve-workflows.ts

  - prompt: |
      Add pre-flight validation checks before sprint execution.

      ## Requirements
      - Before the sprint loop starts, validate:
        - All referenced workflow files exist
        - PROGRESS.yaml is valid and not corrupted
        - Required tools are available (yq, node, claude CLI)
        - Sprint directory is writable
      - Create a new script `preflight-check.sh` that runs these validations
      - Integrate preflight checks into sprint-loop.sh (run before main loop)
      - Exit with clear error message if any check fails

      ## Files to create/modify
      - plugins/m42-sprint/scripts/preflight-check.sh (new)
      - plugins/m42-sprint/scripts/sprint-loop.sh

  - prompt: |
      Make unresolved template variables a compilation error (not warning).

      ## Requirements
      - Change `checkUnresolvedVariables` to return errors, not warnings
      - Add option to compiler CLI: `--strict` that treats warnings as errors
      - By default, keep as warnings for backwards compatibility
      - When --strict is passed, unresolved variables fail compilation
      - Update compiler CLI help text

      ## Files to modify
      - plugins/m42-sprint/compiler/src/validate.ts
      - plugins/m42-sprint/compiler/src/index.ts
      - plugins/m42-sprint/compiler/src/compile.ts

  - prompt: |
      Add basic error recovery mechanism for failed phases.

      ## Requirements
      - When a phase fails (Claude CLI returns non-zero), capture the error
      - Add `error` field to phase status in PROGRESS.yaml
      - Add `retry-count` field to track retry attempts
      - Add `--max-retries N` option to sprint-loop.sh (default: 0)
      - If retries exhausted, set status to `blocked` with error details
      - Allow manual retry by resetting phase status to `pending`

      ## Files to modify
      - plugins/m42-sprint/compiler/src/types.ts
      - plugins/m42-sprint/scripts/sprint-loop.sh
      - plugins/m42-sprint/scripts/build-sprint-prompt.sh
