# SPRINT.yaml - M42-Sprint Plugin Enhancement Sprint
# This file is compiled into PROGRESS.yaml by /run-sprint

workflow: gherkin-verified-execution

steps:
  # ==========================================================================
  # Phase 1: P0 Quick Wins
  # ==========================================================================

  - prompt: |
      Phase 1 - Step 1: Fix Elapsed Timer Running Indefinitely

      The elapsed time timer continues updating after sprint completes/pauses/fails.

      Requirements:
      - Modify `updateElapsedTimes()` function in page.ts
      - Check sprint status before updating timers
      - Stop updating for terminal statuses: 'completed', 'failed', 'stopped', 'blocked'
      - Also handle 'paused' status (freeze timer, don't stop)
      - Ensure timer resumes correctly when sprint is resumed from pause

      Verification:
      - Complete a sprint, verify timer stops at completion time
      - Pause a sprint, verify timer freezes
      - Resume a sprint, verify timer continues from paused value

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts (~line 2989, updateElapsedTimes function)

  - prompt: |
      Phase 1 - Step 2: Update Default Max Iterations (30 → 60)

      The default of 30 iterations is insufficient for larger sprints.

      Requirements:
      - Update default value in run-sprint.md command documentation
      - Update reference documentation in docs/reference/commands.md
      - Update USER-GUIDE.md with new default
      - Ensure all mentions of "default: 30" are changed to "default: 60"

      Verification:
      - Search for all occurrences of max-iterations default value
      - Verify consistency across all documentation

      Files to modify:
      - plugins/m42-sprint/commands/run-sprint.md
      - plugins/m42-sprint/docs/reference/commands.md
      - plugins/m42-sprint/docs/USER-GUIDE.md

  - prompt: |
      Phase 1 - Step 3: Fix Desktop Notifications Not Working

      Notifications are enabled but not appearing due to browser autoplay policy and missing error handling.

      Requirements:
      - Add try-catch error handling to `showNotification()` function
      - Pre-initialize AudioContext on first user interaction (click handler)
      - Add "Test Notification" button in the notification settings panel
      - Show toast fallback when notification permission denied or fails
      - Log notification errors to console for debugging
      - Handle case where Notification API is not available

      Verification:
      - Enable notifications in settings
      - Click "Test Notification" button, verify notification appears
      - Verify toast fallback shows when notifications are blocked

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts (~lines 1948-2169, notification section)

  # ==========================================================================
  # Phase 2: P0 Core Reliability
  # ==========================================================================

  - prompt: |
      Phase 2 - Step 1: Create Cross-Platform Browser Opener Utility

      Create a new utility module for opening browsers across different platforms.

      Requirements:
      - Create browser.ts with `openBrowser(url: string): Promise<void>` function
      - Detect platform: darwin (macOS), win32 (Windows), linux
      - Use appropriate command: `open` (macOS), `start` (Windows), `xdg-open` (Linux)
      - Handle errors gracefully (browser not found, etc.)
      - Export function for use in index.ts
      - Add fallback message to console if browser fails to open

      Verification:
      - Import and call openBrowser() with a URL
      - Verify browser opens on current platform

      New file to create:
      - plugins/m42-sprint/compiler/src/status-server/browser.ts

  - prompt: |
      Phase 2 - Step 2: Add EventEmitter Pattern to StatusServer

      Implement ready signal using EventEmitter pattern to eliminate race condition.

      Requirements:
      - Import EventEmitter from 'events' in server.ts
      - Make StatusServer extend EventEmitter (or add as property)
      - Emit 'ready' event AFTER server.listen() callback fires
      - Add `waitForReady(): Promise<void>` method that resolves on 'ready' event
      - Write port file ONLY after server is confirmed listening
      - Add timeout handling (fail after 10 seconds if server doesn't start)

      Verification:
      - Call waitForReady() before sprint loop starts
      - Verify port file exists only after server is ready
      - Verify timeout triggers if server fails to start

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/server.ts

  - prompt: |
      Phase 2 - Step 3: Integrate Browser Auto-Open in Status Server Startup

      Make browser auto-open the default behavior when starting status server.

      Requirements:
      - Import openBrowser from browser.ts in index.ts
      - Call waitForReady() before proceeding (blocking startup)
      - Auto-open browser after server is ready (use openBrowser utility)
      - Add `--no-browser` flag support to disable auto-open
      - Pass browser preference through function parameters
      - Log status server URL to console regardless of browser open

      Verification:
      - Start sprint, verify browser opens automatically within 3 seconds
      - Start with --no-browser flag, verify browser does NOT open
      - Verify sprint loop only starts after server is ready

      Files to modify:
      - plugins/m42-sprint/compiler/src/status-server/index.ts
      - plugins/m42-sprint/commands/run-sprint.md (add --no-browser flag documentation)

  # ==========================================================================
  # Phase 3: P1 Developer Experience
  # ==========================================================================

  - prompt: |
      Phase 3 - Step 1: Implement Keyboard Shortcuts

      Add keyboard navigation for common actions in the status page.

      Requirements:
      - Add global keydown event listener
      - Implement shortcuts:
        - `P` - Pause/Resume sprint (toggle based on current state)
        - `L` - Toggle live activity panel visibility
        - `N` - Open notification settings modal
        - `D` - Download all logs (trigger download-all-logs action)
        - `Esc` - Close any open modals
        - `?` - Show keyboard shortcuts help modal
      - Create shortcuts help modal with list of all shortcuts
      - Ignore shortcuts when typing in input fields
      - Add visual hints in UI (e.g., underline P in Pause button)

      Verification:
      - Press `?` to see shortcuts help modal
      - Test each shortcut works correctly
      - Verify shortcuts are ignored when typing in search/input

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts

  - prompt: |
      Phase 3 - Step 2: Add Enhanced Error Messages with Recovery Actions

      Show contextual error details with actionable recovery guidance.

      Requirements:
      - Create error classification system for phase failures
      - Categories: network, rate-limit, timeout, validation, logic
      - Display error category badge in failed phase cards
      - Show recovery suggestions based on error type:
        - network: "Check internet connection and retry"
        - rate-limit: "Wait a few minutes before retrying"
        - timeout: "Phase took too long - try breaking into smaller steps"
        - validation: "Review input/output requirements"
        - logic: "Review Claude's reasoning in the log"
      - Add "View Error Details" expandable section in phase cards
      - Include stack trace or relevant error message

      Verification:
      - Trigger a phase failure (e.g., network timeout)
      - Verify error category is displayed
      - Verify recovery suggestion is relevant to error type

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts

  - prompt: |
      Phase 3 - Step 3: Enhance Log Viewer

      Improve the log viewer with line numbers, search navigation, and jump to error.

      Requirements:
      - Add line numbers column to log display (fixed width, right-aligned)
      - Implement search within logs:
        - Search input field at top of log viewer
        - Highlight all matches in log content
        - "Next" and "Previous" buttons to navigate between matches
        - Show match count (e.g., "3 of 12 matches")
      - Add "Jump to Error" button that scrolls to first error/failure line
      - Error lines should be highlighted with red background
      - Preserve line number visibility when scrolling horizontally

      Verification:
      - Open a log with errors, verify line numbers display
      - Search for a term, verify highlighting and navigation
      - Click "Jump to Error", verify scroll to error line

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts

  # ==========================================================================
  # Phase 4: P1 Major Feature - Sprint Dashboard
  # ==========================================================================

  - prompt: |
      Phase 4 - Step 1: Create SprintScanner Module

      Create module to enumerate and parse all sprints in .claude/sprints/ directory.

      Requirements:
      - Create sprint-scanner.ts with SprintScanner class
      - Scan .claude/sprints/ directory for sprint folders
      - Parse PROGRESS.yaml from each sprint to extract:
        - Sprint ID, name, status
        - Start time, end time, duration
        - Step count, completed count
        - Workflow used
      - Sort sprints by date (newest first)
      - Limit to last 50 sprints for performance
      - Handle missing/corrupted PROGRESS.yaml gracefully
      - Export SprintSummary type and SprintScanner class

      Verification:
      - Call SprintScanner.scan() and verify list of sprints returned
      - Verify sprints are sorted correctly
      - Verify corrupted sprint folders don't crash scanner

      New file to create:
      - plugins/m42-sprint/compiler/src/status-server/sprint-scanner.ts

  - prompt: |
      Phase 4 - Step 2: Create MetricsAggregator Module

      Create module to aggregate statistics across multiple sprints.

      Requirements:
      - Create metrics-aggregator.ts with MetricsAggregator class
      - Accept array of SprintSummary objects
      - Calculate aggregate metrics:
        - Total sprints (completed, failed, in-progress)
        - Average sprint duration
        - Average steps per sprint
        - Success rate percentage
        - Most common workflows used
        - Sprints per day/week trend
      - Export AggregateMetrics type and MetricsAggregator class

      Verification:
      - Pass sprint summaries to aggregator
      - Verify all metrics are calculated correctly
      - Verify edge cases (empty array, single sprint)

      New file to create:
      - plugins/m42-sprint/compiler/src/status-server/metrics-aggregator.ts

  - prompt: |
      Phase 4 - Step 3: Create Dashboard Page HTML

      Create the dashboard page showing sprint history and metrics.

      Requirements:
      - Create dashboard-page.ts with generateDashboardPage() function
      - Header with "Sprint Dashboard" title and link to docs
      - Metrics summary cards at top:
        - Total sprints, Success rate, Avg duration, Active sprint
      - Sprint list table with columns:
        - Sprint ID (link to detail view)
        - Status (with colored badge)
        - Started, Duration, Steps (completed/total)
      - Pagination or "Load more" for >20 sprints
      - Style consistent with existing page.ts GitHub dark theme
      - Include navigation link to current sprint (if active)

      Verification:
      - Generate dashboard HTML with sample data
      - Verify all sections render correctly
      - Verify links work correctly

      New file to create:
      - plugins/m42-sprint/compiler/src/status-server/dashboard-page.ts

  - prompt: |
      Phase 4 - Step 4: Add URL Routing to Status Server

      Implement routing to serve dashboard and individual sprint views.

      Requirements:
      - Add URL routing in server.ts:
        - `/` or `/dashboard` - Serve dashboard page
        - `/sprint/:id` - Serve sprint detail page (existing page.ts)
        - `/api/sprints` - Return sprint list JSON
        - `/api/metrics` - Return aggregate metrics JSON
      - Parse URL path to determine which page to serve
      - Pass sprint ID to existing page generation when on detail view
      - Update existing SSE endpoint to include sprint ID context
      - Handle 404 for unknown sprint IDs

      Verification:
      - Navigate to `/`, verify dashboard loads
      - Navigate to `/sprint/<id>`, verify detail page loads
      - Call `/api/sprints`, verify JSON response

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/server.ts

  - prompt: |
      Phase 4 - Step 5: Add Navigation Header to Sprint Detail Page

      Add navigation between dashboard and sprint detail views.

      Requirements:
      - Add navigation bar at top of sprint detail page
      - Include "← Back to Dashboard" link
      - Show breadcrumb: Dashboard > Sprint: <sprint-id>
      - Add sprint switcher dropdown (last 10 sprints)
      - Style navigation consistent with existing header
      - Update dashboard page with same navigation pattern

      Verification:
      - Navigate from dashboard to sprint detail
      - Click "Back to Dashboard", verify navigation
      - Use sprint switcher, verify correct sprint loads

      Files to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts
      - plugins/m42-sprint/compiler/src/status-server/dashboard-page.ts

  - prompt: |
      Phase 4 - Step 6: Update sprint-watch Command for Dashboard Mode

      Add --dashboard flag to sprint-watch command to open dashboard view.

      Requirements:
      - Add `--dashboard` flag to sprint-watch.md command
      - When --dashboard, open browser to `/` instead of `/sprint/<id>`
      - Update command help text with new flag
      - Allow running dashboard mode without active sprint

      Verification:
      - Run `/sprint-watch --dashboard`, verify dashboard opens
      - Run `/sprint-watch` normally, verify sprint detail opens

      File to modify:
      - plugins/m42-sprint/commands/sprint-watch.md

  # ==========================================================================
  # Phase 5: P2 Polish
  # ==========================================================================

  - prompt: |
      Phase 5 - Step 1: Enhanced Connection Status with Reconnection Info

      Show reconnection attempt count and countdown timer when disconnected.

      Requirements:
      - Track reconnection attempt number
      - Show countdown timer to next reconnection attempt
      - Display format: "Reconnecting in 5s... (attempt 3/10)"
      - Add visual indicator (pulsing dot, color change) for connection state
      - Show toast when connection is restored
      - Max 10 reconnection attempts before showing "Connection lost" with manual retry

      Verification:
      - Disconnect server, verify countdown displays
      - Verify attempt counter increments
      - Reconnect server, verify "Connected" toast shows

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts

  - prompt: |
      Phase 5 - Step 2: Add Mobile Responsive CSS

      Make status page usable on mobile and tablet devices.

      Requirements:
      - Add media queries for mobile (<768px) and tablet (<1024px)
      - Stack layout elements vertically on mobile
      - Reduce font sizes and padding on smaller screens
      - Make buttons touch-friendly (min 44px tap target)
      - Hide non-essential elements on mobile (e.g., keyboard shortcut hints)
      - Ensure log viewer is scrollable horizontally
      - Test activity panel collapse/expand on mobile

      Verification:
      - Open status page on mobile device or Chrome DevTools mobile view
      - Verify all content is accessible and readable
      - Verify touch interactions work correctly

      File to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts (CSS section)

  - prompt: |
      Phase 5 - Step 3: Add Performance Metrics Section

      Add collapsible section showing phase timing statistics.

      Requirements:
      - Add collapsible "Performance Metrics" section below sprint progress
      - Display per-phase timing:
        - Phase name, start time, end time, duration
        - Bar chart visualization of relative durations
      - Show sprint totals:
        - Total execution time
        - Average phase duration
        - Longest/shortest phase
      - Fetch data from existing timing.jsonl or /api/timing endpoint
      - Auto-refresh metrics as phases complete

      Verification:
      - Run a sprint with multiple phases
      - Expand metrics section, verify timing data displays
      - Verify bar chart shows relative durations

      Files to modify:
      - plugins/m42-sprint/compiler/src/status-server/page.ts
      - plugins/m42-sprint/compiler/src/status-server/server.ts (add /api/timing if needed)

  # ==========================================================================
  # Final: Build Verification
  # ==========================================================================

  - prompt: |
      Final Step: Build Verification and Cleanup

      Verify all changes compile and pass quality checks.

      Requirements:
      - Run TypeScript compilation: `npm run build` in compiler directory
      - Run type checking: `npm run typecheck` in compiler directory
      - Fix any compilation errors
      - Fix any type errors
      - Ensure no unused imports or variables
      - Verify no console.log statements left in production code (except intentional logging)

      Verification:
      - `npm run build` exits with code 0
      - `npm run typecheck` exits with code 0
      - No warnings in build output

      Directory:
      - plugins/m42-sprint/compiler/

# Sprint metadata
sprint-id: 2026-01-17_plugin-enhancements
name: M42-Sprint Plugin Enhancements
created: 2026-01-17T00:00:00+01:00
description: |
  Comprehensive improvements to the m42-sprint plugin focusing on reliability,
  visibility, and developer experience.

  Phase 1 (P0 Quick Wins):
  - Fix elapsed timer running indefinitely
  - Update default max iterations (30 → 60)
  - Fix desktop notifications not working

  Phase 2 (P0 Core Reliability):
  - Create browser opener utility
  - Add EventEmitter pattern to StatusServer
  - Integrate browser auto-open

  Phase 3 (P1 Developer Experience):
  - Keyboard shortcuts
  - Enhanced error messages with recovery actions
  - Log viewer enhancements

  Phase 4 (P1 Major Feature):
  - Sprint dashboard with history view
  - SprintScanner and MetricsAggregator modules
  - URL routing and navigation

  Phase 5 (P2 Polish):
  - Connection status with reconnection info
  - Mobile responsive CSS
  - Performance metrics section

  Total: 17 steps across 5 phases + build verification
